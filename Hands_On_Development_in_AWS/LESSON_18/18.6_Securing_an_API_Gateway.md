# 18.6 Securing an API Gateway 
 
 - **Purpose of the Demo**
  - Demonstrates securing an **API Gateway REST API** using **API keys**
  - Alternative to using Cognito or Lambda authorizers

- **Initial API Setup**

![create_api.jpg](./IMAGES/18.6_Securing_an_API_Gateway/create_api.jpg)
![create_rest_api.jpg](./IMAGES/18.6_Securing_an_API_Gateway/create_rest_api.jpg)
![setting_api_name.jpg](./IMAGES/18.6_Securing_an_API_Gateway/setting_api_name.jpg)

  - Created a new **REST API**
  - Endpoint type: **Regional**

![create_method.jpg](./IMAGES/18.6_Securing_an_API_Gateway/create_method.jpg)
![create_method_get.jpg](./IMAGES/18.6_Securing_an_API_Gateway/create_method_get.jpg)
![initial_method_get.jpg](./IMAGES/18.6_Securing_an_API_Gateway/initial_method_get.jpg)

  - Added a **GET method** on the root resource
![api_mock.jpg](./IMAGES/18.6_Securing_an_API_Gateway/api_mock.jpg)
  - Integration type: **Mock**
![api_key_required_false.jpg](./IMAGES/18.6_Securing_an_API_Gateway/api_key_required_false.jpg)

![deploy_api.jpg](./IMAGES/18.6_Securing_an_API_Gateway/deploy_api.jpg)
![deploy_stage.jpg](./IMAGES/18.6_Securing_an_API_Gateway/deploy_stage.jpg)

  - Deployed API to the default stage

- **Baseline Test**
![invoke_url.jpg](./IMAGES/18.6_Securing_an_API_Gateway/invoke_url.jpg)
![postman_staus_200.jpg](./IMAGES/18.6_Securing_an_API_Gateway/postman_staus_200.jpg)

  - Sent a GET request via Postman
  - Request succeeded with **200 OK**
  - API key was not yet required

- **API Key Creation**
![create_api_key.jpg](./IMAGES/18.6_Securing_an_API_Gateway/create_api_key.jpg)
![create_api_key_name.jpg](./IMAGES/18.6_Securing_an_API_Gateway/create_api_key_name.jpg)

  - Created a new API key named **ADGULiveKey**
  ![api_keys_show.jpg](./IMAGES/18.6_Securing_an_API_Gateway/api_keys_show.jpg)
  - Key was auto-generated
  - API keys and APIs are separate resources in API Gateway

- **Enabling API Key Requirement**
![go_to_method.jpg](./IMAGES/18.6_Securing_an_API_Gateway/go_to_method.jpg)
  - Modified the GET method

![api_key_required_true.jpg](./IMAGES/18.6_Securing_an_API_Gateway/api_key_required_true.jpg)
  
  - Set **API key required = true**
  ![deploy_api.jpg](./IMAGES/18.6_Securing_an_API_Gateway/deploy_api.jpg)
  ![deploy_stage.jpg](./IMAGES/18.6_Securing_an_API_Gateway/deploy_stage.jpg)
  - Redeployed the API
  - Request still failed to authenticate properly at this stage

- **Usage Plan Requirement**
![create_usage_plan.jpg](./IMAGES/18.6_Securing_an_API_Gateway/create_usage_plan.jpg)

  - API keys must be associated with APIs via a **usage plan**

![create_usage_plan_name.jpg](./IMAGES/18.6_Securing_an_API_Gateway/create_usage_plan_name.jpg)

  - Created a usage plan named **AGGUUP Live**
  - Did not enable throttling or quotas (optional features)

  - Added:
![associated_api_stages.jpg](./IMAGES/18.6_Securing_an_API_Gateway/associated_api_stages.jpg)
![add_api_key_tousage_plan.jpg](./IMAGES/18.6_Securing_an_API_Gateway/add_api_key_tousage_plan.jpg)
    - API and stage to the usage plan (Click on the check mark)

![add_api_to_usage_plan_done.jpg](./IMAGES/18.6_Securing_an_API_Gateway/add_api_to_usage_plan_done.jpg)
    - API key to the usage plan (Click on the check mark)

postman_header_x-api-key.jpg
- **Authentication Behavior**

![postman_status_403.jpg](./IMAGES/18.6_Securing_an_API_Gateway/postman_status_403.jpg)

  - Request without API key returned **403 Forbidden**

![postman_header_x-api-key.jpg](./IMAGES/18.6_Securing_an_API_Gateway/postman_header_x-api-key.jpg)
  - Added header to request:
    - `x-api-key: <API_KEY_VALUE>`

![postman_status_200_with_x-api-key.jpg](./IMAGES/18.6_Securing_an_API_Gateway/postman_status_200_with_x-api-key.jpg)

  - Request succeeded with **200 OK**

- **How API Key Security Works**
  - API key enforcement is configured at the **method request level**
  - API key must be:
    - Created
    - Linked to an API via a usage plan
    - Sent in the request header

- **Usage Plan Capabilities**
  - Connects API keys to APIs
  - Can enforce:
    - Throttling limits
    - Request quotas

  ![one_or_multiple_usage plans.jpg](./IMAGES/18.6_Securing_an_API_Gateway/one_or_multiple_usage plans.jpg)

  - A single API key can be associated with:
    - One or multiple usage plans

- **Key Takeaway**
  - API keys provide simple request authentication
  - They require proper linkage through usage plans
  - Simply enabling “API key required” is not sufficient without a usage plan

 
 ## [Context](./../context.md)